#include <stdio.h>
#include <stdlib.h>
#include <string.h>

main() {
    FILE *filestudents, *fileprofessor, *filesecretariado, *filesenha_secretariado, *filematerias;
    char aluno[100], professor[100], secretariado[100], linha_nome[200], linha_senha[200], senha_secretariado[100], materia[100];
    int opcao, opcao_secretariado, codigo, opcao_professor, matricula, vid, vid2, encontrado = 0;

    do {
        printf("\n=== Sistema Academico ===\n");
        printf("1 - Primeiro acesso\n");
        printf("2 - Entrar como aluno\n");
        printf("3 - Entrar como professor\n");
        printf("4 - Entrar como secretariado\n");
        printf("0 - Sair\n");
        printf("Escolha uma opcao: ");
        scanf("%d", &opcao);
        getchar();

        switch (opcao) {

            case 1:
                printf("\nPrimeiro acesso ao sistema\n");
                printf("Por favor, efetue o cadastro do secretariado:\n");
                printf("Nome: ");

                filesecretariado = fopen("secretario.csv", "a");
                filesenha_secretariado = fopen("senha_secretario.csv", "a");
                if (filesecretariado == NULL) {
                    printf("Erro ao abrir arquivo de secretariado!\n");
                    return 0;
                }

                fgets(secretariado, sizeof(secretariado), stdin);
                secretariado[strcspn(secretariado, "\n")] = '\0';

                printf("Registro: ");
                scanf("%i", &matricula);
                getchar();

                printf("\nAgora, defina uma senha: ");
                fgets(senha_secretariado, sizeof(senha_secretariado), stdin);

                fprintf(filesecretariado, "%s,%i\n", secretariado, matricula);
                fprintf(filesenha_secretariado, "%s\n", senha_secretariado);
                fclose(filesenha_secretariado);
                fclose(filesecretariado);
                printf("Cadastro realizado com sucesso!\n");
                break;

            case 3:
                printf("\n=== Login Professor ===\n");
                fileprofessor = fopen("professor.csv", "r");

                if (fileprofessor == NULL) {
                    printf("Erro, nenhum usuario cadastrado\n");
                    return 0;
                }

                printf("Por favor, digite seu nome: ");
                fgets(professor, sizeof(professor), stdin);
                professor[strcspn(professor, "\n")] = '\0';

                encontrado = 0;
                while (fgets(linha_nome, sizeof(linha_nome), fileprofessor)) {
                    if (strstr(linha_nome, professor)) {
                        encontrado = 1;
                        break;
                    }
                }
                fclose(fileprofessor);

                if (!encontrado) {
                    printf("Professor '%s' nao encontrado! Nao e possivel acessar o menu.\n", professor);
                    return 0;
                }

                do {
                    printf("\n=== MENU PROFESSOR ===\n");
                    printf("0 - Sair\n");
                    printf("Escolha uma opcao: ");
                    scanf("%d", &opcao_professor);
                    getchar();

                    switch (opcao_professor) {
                        case 0:
                            printf("Encerrando menu do professor...\n");
                            break;

                        default:
                            printf("Opcao invalida!\n");
                            break;
                    }

                } while (opcao_professor != 0);
                break;

            case 4:
                printf("\n=== Login Secretariado ===\n");
                filesecretariado = fopen("secretario.csv", "r");
                filesenha_secretariado = fopen("senha_secretario.csv", "r");

                if (filesecretariado == NULL) {
                    printf("Erro, nenhum usuario cadastrado\n");
                    return 0;
                }

                printf("Por favor, digite seu nome: ");
                fgets(secretariado, sizeof(secretariado), stdin);
                secretariado[strcspn(secretariado, "\n")] = '\0';

                printf("\nPor favor, digite sua senha: ");
                fgets(senha_secretariado, sizeof(senha_secretariado), stdin);

                encontrado = 0;
                while (fgets(linha_nome, sizeof(linha_nome), filesecretariado) &&
                       fgets(linha_senha, sizeof(linha_senha), filesenha_secretariado)) {
                    if (strstr(linha_nome, secretariado) && strstr(linha_senha, senha_secretariado)) {
                        encontrado = 1;
                        break;
                    }
                }
                fclose(filesenha_secretariado);
                fclose(filesecretariado);

                if (!encontrado) {
                    printf("Secretario '%s' nao encontrado! Nao e possivel acessar o menu.\n", secretariado);
                    return 0;
                }

                do {
                    printf("\n=== MENU SECRETARIADO ===\n");
                    printf("1 - Cadastrar Estudante\n");
                    printf("2 - Cadastrar Professor\n");
                    printf("3 - Cadastrar Secretariado\n");
                    printf("4 - Incluir Materia\n");
                    printf("0 - Sair\n");
                    printf("Escolha uma opcao: ");
                    scanf("%d", &opcao_secretariado);
                    getchar();

                    switch (opcao_secretariado) {
                        case 1:
                            filestudents = fopen("students.csv", "a");
                            if (filestudents == NULL) {
                                printf("Erro ao abrir arquivo de estudantes!\n");
                                break;
                            }

                            printf("Digite o nome do estudante: ");
                            fgets(aluno, sizeof(aluno), stdin);
                            aluno[strcspn(aluno, "\n")] = '\0';

                            printf("Digite a matricula do estudante: ");
                            scanf("%i", &matricula);
                            getchar();

                            fprintf(filestudents, "%s,%i\n", aluno, matricula);
                            fclose(filestudents);
                            printf("Aluno cadastrado com sucesso!\n");
                            break;

                        case 2:
                            fileprofessor = fopen("professor.csv", "a");
                            if (fileprofessor == NULL) {
                                printf("Erro ao abrir arquivo de professores!\n");
                                break;
                            }

                            printf("Digite o nome do professor: ");
                            fgets(professor, sizeof(professor), stdin);
                            professor[strcspn(professor, "\n")] = '\0';

                            printf("Digite a matricula do professor: ");
                            scanf("%i", &vid);
                            getchar();

                            fprintf(fileprofessor, "%s,%i\n", professor, vid);
                            fclose(fileprofessor);
                            printf("Professor cadastrado com sucesso!\n");
                            break;

                        case 3:
                            filesecretariado = fopen("secretario.csv", "a");
                            if (filesecretariado == NULL) {
                                printf("Erro ao abrir arquivo de secretariado!\n");
                                break;
                            }

                            printf("Digite o nome do secretario: ");
                            fgets(secretariado, sizeof(secretariado), stdin);
                            secretariado[strcspn(secretariado, "\n")] = '\0';

                            printf("Digite a matricula do secretario: ");
                            scanf("%i", &vid2);
                            getchar();

                            fprintf(filesecretariado, "%s,%i\n", secretariado, vid2);
                            fclose(filesecretariado);
                            printf("Secretario cadastrado com sucesso!\n");
                            break;

                        case 4:

                            filematerias = fopen("materias.csv", "a");
                            if (filematerias == NULL) {
                                printf("Erro ao abrir o arquivo de materias!\n");
                                break;
                            }

                            printf("Digite o nome da materia: ");
                            fgets(materia, sizeof(materia), stdin);
                            materia[strcspn(materia, "\n")] = '\0';

                            printf("Digite o codigo da materia: ");
                            scanf("%d", &codigo);
                            getchar();

                            fprintf(filematerias, "%s,%d\n", materia, codigo);
                            fclose(filematerias);
                            printf("Materia cadastrada com sucesso!\n");
                            break;

                        case 0:
                            printf("Encerrando menu do secretariado...\n");
                            break;

                        default:
                            printf("Opcao invalida!\n");
                            break;
                    }

                } while (opcao_secretariado != 0);
                break;

            case 0:
                printf("Saindo...\n");
                break;

            default:
                printf("Opcao invalida!\n");
                break;
        }

    } while (opcao != 0);

    return 0;
}
